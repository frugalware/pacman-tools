#!/bin/bash

die()
{
	echo "genchangelog: $@"
	exit 1
}

# fake functions for fwmakepkg
error() { return 0; }
Fdie() { return 0; }
Finclude() { return 0; }

echo -n "running darcs changes... "
darcs changes FrugalBuild > Changelog
echo "done."

echo -n "updating mysql database... "
[ -z "$arch" ] && arch=`arch`
[ -z "$uploader" ] && uploader=`echo $HOME|sed 's|.*/\(.*\)$|\1|'`
repo=`pwd|sed 's|.*/\(.*\)/.*/.*/.*|\1|'`
if [ "$repo" != "extra" ]; then
	repo="frugalware"
fi

source FrugalBuild || die "errors parsing the FrugalBuild"

. /etc/genchangelog.conf

if [ "$repo" == "frugalware" ]; then
	cd ../../../frugalware-$arch
	../tools/fdb2db -b ../source/ -r frugalware -e $fwver -f frugalware-$fwver.fdb -a $arch -h $dbhost -u $dbuser -d $dbname -t $dbtable -c $pkgname -l $uploader
	if [ ! -z "$subpkgs" ]; then
		for subpkg in "${subpkgs[@]}"
		do
			../tools/fdb2db -b ../source/ -r frugalware -e $fwver -f frugalware-$fwver.fdb -a $arch -h $dbhost -u $dbuser -d $dbname -t $dbtable -c "$subpkg" -s -n $pkgname -l $uploader
		done
	fi
else
	cd ../../../frugalware-$arch
	../../tools/fdb2db -b ../source/ -r extra -e $fwver -f extra-$fwver.fdb -a $arch -h $dbhost -u $dbuser -d $dbname -t $dbtable -c $pkgname -l $uploader
	if [ ! -z "$subpkgs" ]; then
		for subpkg in "${subpkgs[@]}"
		do
			../../tools/fdb2db -b ../source/ -r extra -e $fwver -f extra-$fwver.fdb -a $arch -h $dbhost -u $dbuser -d $dbname -t $dbtable -c $subpkg -s -n $pkgname -l $uploader
		done
	fi
fi
echo "done."
